@using Thinktecture.IdentityServer.Web.App_LocalResources.Account
@model Thinktecture.IdentityServer.Web.ViewModels.ForgotPassword

@{
    ViewBag.Title = ForgotPassword_cshtml.NewPassword;
    Html.EnableClientValidation();
    Html.EnableUnobtrusiveJavaScript();
    
    //if (Model.IsSigninRequest)
    //{
        ViewBag.HideMenu = true;
    //}
}

   

@if (User.Identity.IsAuthenticated)
{
    <h2>@string.Format(SignIn_cshtml.UnauthorizedAuthenticatedUser, User.Identity.Name)</h2>
   
}
@using (Html.BeginForm())
//@using (Html.BeginForm("ForgotPassword", "Account", FormMethod.Post, new { encType = "multipart/form-data" }))
{
    @Html.AntiForgeryToken()
   <form id="forgotPwd">
   <div class="divContent">
    <div class="divContent left">&nbsp;</div>
    <div class="divContent middle">
         @Html.ValidationSummary(true,ForgotPassword_cshtml.SendingEmailUnsuccessful)
        <fieldset class="editor small signin">
        <legend>Forgot Password</legend>
        <div class="divlogo">
          <img src="~/Content/images/OSCid.png" />
        </div>
            <table>
                <tr>
                    <td> @Html.LabelFor(m=>m.UserName)</td>
                    <td> @Html.TextBoxFor(m=>m.UserName)</td>
                </tr>
                <tr>
                    <td></td>
                    <td>@Html.ValidationMessageFor(m=>m.UserName)
                        <div id="lbluserval" class="divResult"></div>
                    </td>
                </tr>
                <tr>
                    <td> @Html.LabelFor(m=>m.EmailId)</td>
                    <td> @Html.TextBoxFor(m=>m.EmailId)</td>
                </tr>
                 <tr>
                    <td></td>
                    <td>@Html.ValidationMessageFor(m=>m.EmailId)
                        <div id="lblemailval" class="divResult"></div> 
                    </td>
                </tr>               
                <tr>
                    <td></td>
                    <td class="buttons">
                           @*<input type="button" id="submit" name="Submit" value="@ForgotPassword_cshtml.Submit" onclick="sendEmail();" />&nbsp;&nbsp;&nbsp;
                           <input type="button" value="@ForgotPassword_cshtml.Back" />*@
                          <a id="linkSubmit" onclick="sendEmail();" class="cssbutton" >Submit</a> 
                          @Html.ActionLink("Back", "signin", "account", new{area=""}, new {@class="cssbutton"})
                         <img id="imgloader" src="~/Content/images/ajax-loader1.gif" class="cssimg" style="display:none;" />
                    </td>
                </tr>
                <tr>
                    <td colspan="2"><div id="Result" class="divResult"></div></td>
                </tr>
            </table>
    </fieldset>
   </div>
     <div class="divContent right">&nbsp;</div>
    </div>
       </form>
}

@section scripts
{           
  <script type="text/javascript">      
      function sendEmail() {
          $('#lbluserval').text("");
          $('#lblemailval').text("");
        var uName = $('#UserName').val();
        var email = $('#EmailId').val();        
        var flag = true;
        if (uName == '') {
            flag = false;
            $('#lbluserval').text("	The User name field is required.");
        }
        if (email == '') {
            flag = false;
            $('#lblemailval').text("The Email field is required.");
        }
        if (flag && !validateEmail(email)) {
            flag = false;
            $('#lblemailval').text("Please enter a valid email address.");
        }       
            if(flag)
            {
                $('#imgloader').css("display", "block");
                $.ajax({
                    type: "POST",
                    contentType: "application/json; charset=utf-8",
                    url: "@Url.Content("~")Account/SendEmail",
                    data: JSON.stringify({ "uName": uName, "email": email }),
                    dataType: "json",
                    beforeSend: function () { },
                    success: function (data) {
                        $("#Result").text("");
                        $('#imgloader').css("display", "none");
                        $("#Result").text(data);
                    },
                    error: function (msg, status) {
                       // alert(msg.status);
                    }
                });
            }
            else
            {
                
            }
       
    }
</script>
    <script type="text/javascript">
        function validateEmail(sEmail) {           
            var filter = /^([\w-\.]+)\@@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([\w-]+\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\]?)$/;
            if (filter.test(sEmail)) {               
                return true;
            }
            else {
                return false;
            }
        }
    </script>
}
